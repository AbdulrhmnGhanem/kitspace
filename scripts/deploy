#!/bin/bash

#exit with non-zero exit code if any process fails
set -e

#  don't do anything on pull-requests
if [ "${TRAVIS_PULL_REQUEST}" != "false" ]
then
    exit 0
elif  [ "${TRAVIS_BRANCH}" != "master" ]
then
    rm -rf build/.temp
    echo -e "User-agent: *\nDisallow: /\n" > build/robots.txt
    echo -e "${SSH_KEY}" > key-file
    chmod 600 key-file
    #replace all occurunces of / with .
    folder=${TRAVIS_BRANCH//\//.}
    ssh -i key-file -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no "ubuntu@preview.kitspace.org" "rm -rf preview/${folder}"
    scp -i key-file -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -r build "ubuntu@preview.kitspace.org:preview/${folder}"
    rm -f key-file
else
    rm -rf build/.temp
    netlify deploy --prod --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --dir=build/
fi

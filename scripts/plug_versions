#!/usr/bin/env node
const fs = require('fs')
const utils = require('./utils')

const repos = utils.readRepos()
const registry = JSON.parse(fs.readFileSync('registry.json', 'utf8'))

Promise.all(
  repos.map(async repo => {
    const existingHash = registry.reduce(
      (existingHash, {repo: r, hash}) => existingHash || (r === repo && hash),
      null
    )
    if (existingHash != null) {
      return {repo, hash: existingHash}
    }
    const hash = await utils.getVersion(repo)
    return {repo, hash}
  })
).then(repos => {
  fs.writeFileSync('registry.json', JSON.stringify(repos, null, 2))
})

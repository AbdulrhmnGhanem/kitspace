#!/usr/bin/env node
const fs = require('fs')
const utils = require('./utils')

const repos = utils.readRepos()
const registry = JSON.parse(fs.readFileSync('./registry.json', 'utf8'))

Promise.all(
  repos.map(
    repo =>
      new Promise((resolve, reject) => {
        const existing = registry.find(x => x.repo === repo)
        if (existing != null) {
          return resolve(existing)
        }
        utils.getVersion(repo, hash => {
          resolve({repo, hash})
        })
      })
  )
).then(updatedRegistry => {
  fs.writeFileSync('./registry.json', JSON.stringify(updatedRegistry, null, 2))
})
